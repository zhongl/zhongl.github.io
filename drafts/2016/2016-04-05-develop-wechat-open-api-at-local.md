---
layout: post
Date: 2016-04-05 12:00:00 +0800
title: '微信开发平台本地调式方法'
tags: [wechat, proxy, ssh, netcat, openapi]
last_modified_at: 2016-08-25 15:20:00 +0800
---

```
          <WOS>                      <AE>                 <ML>
 +--------------------+         +------------+        +-----------+
 | WeChat Open Server | <=====> | Aliyun ECS | <====> | My Laptop |
 +--------------------+         +------------+        +-----------+
```

<!--more-->

### 传统方式

`ML`上开发代码，打包部署到 `AE` 上运行，然后与 `WOS` 联调。

#### 问题

1. `AE` 上开发工具简陋，调试效率低；
2. `ML` 通常在内网没有独立对外 IP，致使 `WOS` 不能直连。

### 改进方式

思路是将 `AE` 作为**透传代理**。 实现方式如下：

#### SSH 远程转发

```
ML> ssh -R '8080:localhost:12306' {AE}
```

在 `ML` 上执行上面的命令连接 `AE`， 将 `AE` 上所有 `8080` 端口的请求转发到 `ML` 的 `12306` 端口上。

> 这里会遇到一个坑，`SSH`默认只会转发所有到`127.0.0.1:8080`的数据。显然这不是我们想要的，然而`Aliyun ECS`上即便修改`GatewayPorts=yes`也无法实现转发来自对外 IP 的数据，故此有了下面的办法。
>

#### NC 本地转发

```
AE> nc --sh-exec "nc localhost 8080" -l 80 --keep-open
```

在 `AE` 上执行上述命令， 实现监听 `80` 端口并将所有数据透传到本地的 `8080` 端口。

The end.
